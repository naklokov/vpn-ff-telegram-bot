const { Scenes } = require("telegraf");
const {
  SCENE_IDS,
  PHONE_REGEXP,
  ADMIN_CHAT_ID,
  USERS_TEXT,
  DEVELOPER_CONTACT,
} = require("../../constants");
const {
  getMainMenu,
  hideButtons,
  exitButtonScene,
} = require("../../components/buttons");
const { usersConnector } = require("../../db");
const { addVlessUser } = require("../../utils/vless");
const logger = require("../../utils/logger");
const { getUserPersonalDataFromContext } = require("../../utils/common");
const dayjs = require("dayjs");

const exitScene = async (ctx) => {
  await ctx.scene.leave();
  await ctx.reply(USERS_TEXT.mainMenu, hideButtons);
  await ctx.reply(USERS_TEXT.selectActions, await getMainMenu(ctx));
};

const migrateToSlaveScene = new Scenes.WizardScene(
  SCENE_IDS.MIGRATE_TO_SLAVE,
  async (ctx) => {
    const { id: chatId } = getUserPersonalDataFromContext(ctx);
    if (chatId !== ADMIN_CHAT_ID) {
      ctx.reply("Ð’Ð°Ð¼ ÑÑŽÐ´Ð° Ð½ÐµÐ»ÑŒÐ·Ñ)");
      await exitScene(ctx);
      return;
    }

    ctx.reply(
      "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð½Ð° Ð½Ð¾Ð²Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€",
      exitButtonScene,
    );
    return ctx.wizard.next();
  },
  async (ctx) => {
    try {
      const userPhone = ctx.message.text;

      if (!PHONE_REGEXP.test(userPhone)) {
        ctx.reply(
          "ÐÐ¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° Ð²Ð²ÐµÐ´Ñ‘Ð½ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.",
          exitButtonScene,
        );
        return;
      }

      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
      const dbUser = await usersConnector.getUserByPhone(userPhone);

      if (!dbUser) {
        ctx.reply(
          `ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð¼ ${userPhone} Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ….`,
        );
        await exitScene(ctx);
        return;
      }

      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ serverPrefix Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      await usersConnector.updateUserByPhone(userPhone, {
        serverPrefix: process?.env?.NEW_USER_SERVER_PREFIX,
      });

      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð° Ð½Ð¾Ð²Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€
      const expiryTime = dayjs(dbUser.expiredDate).toDate();
      await addVlessUser({
        phone: dbUser.phone,
        chatId: dbUser.chatId,
        expiryTime: expiryTime,
        serverPrefix: process?.env?.NEW_USER_SERVER_PREFIX,
      });

      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
      if (dbUser.chatId) {
        await ctx.telegram.sendMessage(
          dbUser.chatId,
          "ðŸ”„ Ð’Ñ‹ Ð¼Ð¸Ð³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð½Ð° Ð½Ð¾Ð²Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€!\n\n" +
            "ÐŸÑ€Ð¾ÑÑŒÐ±Ð° Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° Ð½ÐµÐ³Ð¾ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ Ñ‚Ñ€Ñ‘Ñ… Ð´Ð½ÐµÐ¹.\n" +
            "Ð”Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿ÑƒÐ½ÐºÑ‚ 'ðŸ“– ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° VPN' Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ð¼ Ð¼ÐµÐ½ÑŽ.\n\n" +
            "Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ðŸ‘‰ " +
            DEVELOPER_CONTACT,
        );
      }

      await ctx.reply(
        `âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${userPhone} ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¼Ð¸Ð³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð½Ð° Ð½Ð¾Ð²Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€.\n` +
          `ðŸ“± Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ.`,
      );
    } catch (error) {
      logger.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:", error);
      ctx.reply("ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ");
    } finally {
      await exitScene(ctx);
    }
  },
);

migrateToSlaveScene.hears(USERS_TEXT.exitScene, async (ctx) => {
  await exitScene(ctx);
});

module.exports = { migrateToSlaveScene };
